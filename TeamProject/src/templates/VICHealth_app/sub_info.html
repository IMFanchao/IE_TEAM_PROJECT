<!DOCTYPE html>
{% load staticfiles %}
<html lang="en" dir="ltr">

<head>
  <meta charset="utf-8">
  <title>Home</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAPLzx2XWLc_6CBb5m9XXEz5pv_wTprUsA&callback=initMap" type="text/javascript"></script>
</head>

<body>
  <header class="navbar navbar-expand-lg fixed-top navbar-light bg-light">
    <a class="navbar-brand" href="{%url 'VICHealth_app:index'%}">Activity4Children</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item active">
          <a class="nav-link" href="{%url 'VICHealth_app:index'%}">Home</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{%url 'VICHealth_app:check_activity_level'%}">Check Activity Level</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{%url 'VICHealth_app:sub_info'%}">Suburb Information</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{%url 'VICHealth_app:health_tips'%}">Healthy Tips</a>
        </li>
    </div>
  </header>
  <br>
  <br>
  <div class="container" style="background:grey;">
    <div id="test" style="height:20px;"></div>
    <!--Input form -->
    <div style="width:90%;background:white;margin:0 auto">
      <form id="inputform" method="post">
        <input type="text" name="suburb" id="suburb" placeholder="Your suburb">
        <input type="text" name="activity" id="activity" placeholder="Your activity">
        {% csrf_token %}
        <input type="button" class="btn btn-primary" value="Check" onclick="updateMap()">
      </form>
    </div>
    <!--Google map feature -->
    <div id="googleMap" style="width:90%;height:500px;margin:0 auto"></div>
    <script>
      var map;
      var gMarkersOg = new Array();
      var gMarkers = new Array();

      function myMap() {
        var mapProp = {
          //Center is Victoria
          center: new google.maps.LatLng(-37.4, 144.7),
          zoom: 8,
        };
        map = new google.maps.Map(document.getElementById("googleMap"), mapProp);
        map.setMapTypeId(google.maps.MapTypeId.HYBRID);

        //Set center to user location
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
            initialLocation = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
            map.setCenter(initialLocation);
          });
        }

      }
      myMap();

      /**
      Click check button to update the map
      */
      function updateMap() {
        // Clear suburb markers
          if(gMarkersOg.length > 0) {
            for(i=0 ; i<gMarkersOg.length ; i++) {
              gMarkersOg[i].setMap(null);
            }
          gMarkersOg = new Array();
          }
          // Clear actvity markers
          if(gMarkers.length > 0) {
            for(i=0 ; i<gMarkers.length ; i++) {
              gMarkers[i].setMap(null);
            }
            gMarkers = new Array();
          }

        //search suburb
        var suburb = document.getElementById("suburb").value;
        var activity = document.getElementById("activity").value;
        var geocoder = new google.maps.Geocoder();

        if (suburb != null && suburb != "") {

                {%for mark in club %}
                  var postcode = '{{mark.postcode}}'.toString().toUpperCase();
                  var markSuburb = '{{mark.suburb}}'.toString().toUpperCase();
                  var suburbStr = suburb.toString().toUpperCase();
                  document.getElementById('test').innerHTML = postcode + " " + markSuburb + " " + suburbStr;
              if (postcode === suburb || markSuburb.match(suburbStr) != null) {
                  var point = new google.maps.LatLng({{mark.latitude}}, {{mark.longitude}});
                  var marker = new google.maps.Marker({
                    position: point,
                    map: map,
                  });
                  marker['infowindow'] = new google.maps.InfoWindow({
                    content: "<h6>{{mark.name}}</h6> <br> {{ mark.address }} ",
                  });
                  marker.setAnimation(google.maps.Animation.DROP);

                  google.maps.event.addListener(marker, 'click', function() {
                    //window.location.href = this.url;
                    //map.setCenter(point);
                    //map.setZoom(12);
                  });
                  google.maps.event.addListener(marker, 'mouseover', function() {
                    // this['infowindow'].open(map, this);
                    this['infowindow'].open(map, this);
                  });
                  google.maps.event.addListener(marker, 'mouseout', function() {
                    // this['infowindow'].close(map, this);
                    this['infowindow'].close(map, this);
                  });

                  gMarkersOg.push(marker);
                  }
                  {% endfor %}
                  if(gMarkersOg.length == 0) {
                    window.alert("Acitivity not found in this suburb!");
                  } else {
                    geocoder.geocode({'address': suburb, componentRestrictions: { country: 'AU'}},
                    function(results, status) {
                        if (status == google.maps.GeocoderStatus.OK) {
                          map.setCenter(results[0].geometry.location);
                          map.setZoom(12);
                          }else {
                            window.alert('Geocode was not successful for the following reason: ' + status);
                          }
                        });
                  }

      }



      if (activity != null && activity!= "") {
        //Clean privous markers
        if(gMarkersOg.length > 0) {
          for(i=0 ; i<gMarkersOg.length; i++) {
            gMarkersOg[i].setMap(null);
          }
          gMarkersOg = new Array();
        }

        if(gMarkers.length > 0) {
          for(i=0 ; i<gMarkers.length; i++) {
            gMarkers[i].setMap(null);
          }
          gMarkers = new Array();
        }

        //Create new markers
        {% for mark in club %}
        var category = '{{mark.type}}'.toString().toUpperCase();
        var activityStr = activity.toString().toUpperCase();
        // Check equality
        if (category.match(activityStr) != null) {

          var point = new google.maps.LatLng({{mark.latitude}}, {{mark.longitude}});
          var marker = new google.maps.Marker({
              position: point,
              map: map,
            });
            marker['infowindow']  = new google.maps.InfoWindow({
                       content: "<h6>{{mark.name}}</h6> <br> {{ mark.address }} ",
          });

          if (marker.getAnimation() != google.maps.Animation.BOUNCE) {
            marker.setAnimation(google.maps.Animation.BOUNCE);
          }

              google.maps.event.addListener(marker, 'click', function() {
                  //window.location.href = this.url;
                  //map.setCenter(point);
                  //map.setZoom(12);
              });
             google.maps.event.addListener(marker, 'mouseover', function() {
                  this['infowindow'].open(map, this);
                      });
             google.maps.event.addListener(marker, 'mouseout', function() {
                  this['infowindow'].close(map, this);

              });

              //Add marker to marker list
              gMarkers.push(marker);
            }
        {% endfor %}
        if(gMarkers.length == 0) {
          window.alert("We do not have record about this type of activity!");
        }
      }
      }
    </script>
    <div style="height:20px;"></div>
  </div>
</body>

</html>
