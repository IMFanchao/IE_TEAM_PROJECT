<!DOCTYPE html>
{% load staticfiles %}
<html lang="en" dir="ltr">

<head>
  <meta charset="utf-8">
  <title>Home</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAPLzx2XWLc_6CBb5m9XXEz5pv_wTprUsA&callback=initMap" type="text/javascript"></script>
</head>

<body>
  <header class="navbar navbar-expand-lg fixed-top navbar-light bg-light">
    <a class="navbar-brand" href="#">NewClear</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item active">
          <a class="nav-link" href="{%url 'VICHealth_app:index'%}">Home <span class="sr-only">(current)</span></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{%url 'VICHealth_app:check_activity_level'%}">Check Activity Level</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{%url 'VICHealth_app:sub_info'%}">Suburb Information</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{%url 'VICHealth_app:health_tips'%}">Healthy Tips</a>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Dropdown
          </a>
          <div class="dropdown-menu" aria-labelledby="navbarDropdown">
            <a class="dropdown-item" href="#">Action</a>
            <a class="dropdown-item" href="#">Another action</a>
            <div class="dropdown-divider"></div>
            <a class="dropdown-item" href="#">Something else here</a>
          </div>
        </li>
        <li class="nav-item">
          <a class="nav-link disabled" href="#" tabindex="-1" aria-disabled="true">Disabled</a>
        </li>
      </ul>
      <form class="form-inline my-2 my-lg-0">
        <input class="form-control mr-sm-2" type="search" placeholder="Search" aria-label="Search">
        <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>
      </form>
    </div>
  </header>
  <br>
  <br>
  <div class="container" style="background:grey;">
    <div id="test" style="height:20px;"></div>
    <!--Input form -->
    <div style="width:90%;background:white;margin:0 auto">
      <form id="inputform" method="post">
        <input type="text" name="suburb" id="suburb" placeholder="Your suburb">
        <input type="text" name="activity" id="activity" placeholder="Your activity">
        {% csrf_token %}
        <input type="button" class="btn btn-primary" value="Check" onclick="updateMap()">
      </form>
    </div>
    <!--Google map feature -->
    <div id="googleMap" style="width:90%;height:500px;margin:0 auto"></div>
    <script>
      var map;
      var gMarkersOg = new Array();
      var gMarkers = new Array();

      function myMap() {
        var mapProp = {
          //Center is Victoria
          center: new google.maps.LatLng(-37.4, 144.7),
          zoom: 8,
        };
        map = new google.maps.Map(document.getElementById("googleMap"), mapProp);

        //Set center to user location
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
            initialLocation = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
            map.setCenter(initialLocation);
            /** Center marker
            var marker = new google.maps.Marker({
              position: initialLocation,
              map: map,
              title: 'Your location'
            });
            */
          });
        }

        //Add marker from database
        {% for mark in club %}
          var point = new google.maps.LatLng({{mark.latitude}}, {{mark.longitude}});
          var marker = new google.maps.Marker({
              position: point,
              map: map,
            });
            marker['infowindow']  = new google.maps.InfoWindow({
                       content: "<h6>{{mark.name}}</h6> <br> {{ mark.address }} ",
          });
          marker.setAnimation(google.maps.Animation.DROP);
          map.setMapTypeId(google.maps.MapTypeId.HYBRID);

              google.maps.event.addListener(marker, 'click', function() {
                  //window.location.href = this.url;
                  map.setCenter(point);
                  map.setZoom(12);
              });
             google.maps.event.addListener(marker, 'mouseover', function() {
                  // this['infowindow'].open(map, this);
                  this['infowindow'].open(map, this);
                      });
             google.maps.event.addListener(marker, 'mouseout', function() {
                  // this['infowindow'].close(map, this);
                  this['infowindow'].close(map, this);

              });
              gMarkersOg.push(marker);
        {% endfor %}
      }
      myMap();

      /**
      Click check button to update the map
      */
      function updateMap() {
        //search suburb
        var suburb = document.getElementById("suburb").value;
        var activity = document.getElementById("activity").value;
        var geocoder = new google.maps.Geocoder();
        if (suburb != null && suburb != "") {
          geocoder.geocode({
            'address': suburb,
            componentRestrictions: {
              country: 'AU'
          }
          }, function(results, status) {
            if (status == google.maps.GeocoderStatus.OK) {
              map.setCenter(results[0].geometry.location);
              map.setZoom(12);
            } else {
              window.alert('Geocode was not successful for the following reason: ' + status);
            }
          });
      } else if (activity == "") {
        if(gMarkersOg.length > 0) {
          for(i=0 ; i<gMarkersOg.length; i++) {
            gMarkersOg[i].setMap(map);
          }
        }
      }

      if (activity != null && activity!= "") {
        // Clean privous markers
        if(gMarkersOg.length > 0) {
          for(i=0 ; i<gMarkersOg.length; i++) {
            gMarkersOg[i].setMap(null);
          }
        }

        if(gMarkers.length > 0) {
          /**
          for(marker in gMarkers) {
            marker.setMap(null);
          }
          */
          for(i=0 ; i<gMarkers.length; i++) {
            gMarkers[i].setMap(null);
          }
          gMarkers = new Array();
        }

        //Create new markers
        {% for mark in club %}
        var category = '{{mark.type}}'.toString().toUpperCase();
        var activityStr = activity.toString().toUpperCase();
        // Check equality
        if (category.match(activityStr) != null) {

          var point = new google.maps.LatLng({{mark.latitude}}, {{mark.longitude}});
          var marker = new google.maps.Marker({
              position: point,
              map: map,
            });
            marker['infowindow']  = new google.maps.InfoWindow({
                       content: "<h6>{{mark.name}}</h6> <br> {{ mark.address }} ",
          });

          if (marker.getAnimation() != google.maps.Animation.BOUNCE) {
            marker.setAnimation(google.maps.Animation.BOUNCE);
          }

              google.maps.event.addListener(marker, 'click', function() {
                  //window.location.href = this.url;
                  //map.setCenter(point);
                  //map.setZoom(12);
              });
             google.maps.event.addListener(marker, 'mouseover', function() {
                  this['infowindow'].open(map, this);
                      });
             google.maps.event.addListener(marker, 'mouseout', function() {
                  this['infowindow'].close(map, this);

              });

              //Add marker to marker list
              gMarkers.push(marker);
            }
        {% endfor %}
      }
      }
    </script>
    <div style="height:20px;"></div>
  </div>
  
  <footer class="navbar fixed-bottom navbar-light bg-light">
    <div class="container">
      <a class="navbar-brand" href="#">TA14 | Finlay | Zhe
        Jane | Hong </a>
    </div>
  </footer>
</body>

</html>
